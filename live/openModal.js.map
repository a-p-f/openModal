{"version":3,"file":"openModal.js","sources":["../src/modalParent.js","../src/modalChild.js","../src/targetModal.js"],"sourcesContent":["import {safeGetState} from './utils.js';\n\nlet iframe;\nlet lockedScrollTop, lockedScrollLeft;\nlet previousActiveElement;\nlet onModalclose;\nlet modalCloseValue;\n\n// listen to messages from child\naddEventListener('message', function(e) {\n\tif (!iframe) return\n\tif (e.source != iframe.contentWindow) return\n\n\tif (e.data.modalChildTitled) {\n\t\tiframe.setAttribute('aria-label', e.data.modalChildTitled);\n\t}\n\tif ('setModalCloseValue' in e.data) {\n\t\tconsole.debug('received set close value message');\n\t\t_setOpenModalCloseValue(e.data.setModalCloseValue);\n\t}\n\tif ('closeModal' in e.data) {\n\t\tcloseModal();\n\t}\n});\n/*\n\tIn some browsers (safari), when the modal goes back to it's original history state, the popstate event will be fired in this window.\n*/\naddEventListener('popstate', function() {\n\tif (iframe) closeModal();\n});\n\n// same origin children will call this directly, allowing them to pass any value, not just serializable ones\nwindow._setOpenModalCloseValue = function(value) {\n\tmodalCloseValue = value;\n\t// Tell the child window to unwind its history\n\t// It will be closed AFTER history unwinds\n\tiframe.contentWindow.postMessage('MODAL_CLOSE_VALUE_RECEIVED', '*');\n}\nfunction closeModal() {\n\tif (!iframe) {\n\t\tthrow new Error('No modal window is currently open.');\n\t}\n\tiframe.parentElement.removeChild(iframe);\n\tremoveEventListener('scroll', fixScroll);\n\tremoveEventListener('click', cancel, true);\n\tdocument.body.removeEventListener('focus', refocus_iframe, true); \n\tpreviousActiveElement && previousActiveElement.focus();\n\tiframe = null;\n\n\tonModalclose && onModalclose(modalCloseValue);\n\tonModalclose = null;\n}\n\nwindow.openModal = function(url, options={}) {\n\tif (iframe) {\n\t\tthrow new Error('A modal window is already open. A window may only open one modal window at a time.');\n\t}\n\n\tpreviousActiveElement = document.activeElement;\n\tlockedScrollLeft = document.documentElement.scrollLeft;\n\tlockedScrollTop = document.documentElement.scrollTop;\n\taddEventListener('scroll', fixScroll);\n\taddEventListener('click', cancel, true);\n\tdocument.body.addEventListener('focus', refocus_iframe, true);\n\n\tonModalclose = options.onclose;\n\n\tiframe = createIframe();\n\tif (options.background) {\n\t\tiframe.style.background = options.background;\n\t}\n\tiframe.addEventListener('load', function(e) {\n\t\toptions.onload && options.onload(iframe.contentWindow);\n\t});\n\tiframe.src = url;\n}\nfunction createIframe() {\n\tvar i = document.createElement('iframe');\n\tvar s = i.style;\n\ts.position= 'fixed';\n\ts.top = 0;s.left = 0;s.width = '100%';s.height = '100%';\n\ts.border = 'none';\n\ts.margin = 0; s.padding = 0;\n\t// This is MAX_SAFE_INTEGER in JS\n\t// This is larger than the maximum supported z-index in any current browser\n\t// All modern browsers treat this as equivalent to the maximum possible z-index\n\t// TODO - test\n\ts.zIndex = 9007199254740991;\n\n\t// TODO - fallback for browsers not supporting position: fixed (Opera Mini)\n\ti.setAttribute('role', 'dialog');\n\t// TODO - test with screen reader in Safari, ensure content is accessible\n\t// See https://bugs.webkit.org/show_bug.cgi?id=174667\n\t// and https://developer.paciellogroup.com/blog/2018/06/the-current-state-of-modal-dialog-accessibility/\n\t// which suggest there is a serious issue in safari\n\ti.setAttribute('aria-modal', 'true');\n\tdocument.body.appendChild(i);\n\treturn i;\n}\nfunction fixScroll() {\n\tdocument.documentElement.scrollTop = lockedScrollTop;\n\tdocument.documentElement.scrollLeft = lockedScrollLeft;\n}\nfunction cancel(event) {\n\tevent.stopPropagation();\n\tevent.preventDefault();\n}\nfunction refocus_iframe() {\n\tif (document.activeElement != iframe) iframe.focus();\n}","let depthKey;\n\nfunction isModalChild() {\n\t// TODO - more robust check?\n\treturn window.parent != window;\n}\naddEventListener('message', function(e) {\n\tif (e.source != window.parent) return\n\tif (e.data == 'MODAL_CLOSE_VALUE_RECEIVED') {\n\t\tconsole.debug('parent acked value. unwinding...')\n\t\t// Go back to initial state before closing the modal window\n\t\t// In some browsers, this will trigger popstate in our window\n\t\t// (and our popstate listener will call exit())\n\t\t// In other browsers, this will cause a popstate event in the parent window\n\t\thistory.go(-1 * parseInt(sessionStorage[depthKey]));\n\n\t\t// IE hack\n\t\t// In some edge cases, the above history unwind will neither fire popstate nor load a new page (even though it does correctly change history entry)\n\t\t// TODO - guard this with an \"is IE\" check, so we know we aren't using this garbage in other browsers?\n\t\tsetTimeout(exit, 200);\n\t}\n});\nwindow.closeModal = function(value) {\n\tif (!isModalChild()) {\n\t\tthrow new Error('This is not a modal window');\n\t}\n\n\t// Parent will let us know when it receives this message, then we'll unwind history\n\t// TODO - test same origin with non-serializable value, test cross-origin\n\ttry {\n\t\twindow.parent._setOpenModalCloseValue(value);\n\t} catch(e) {\n\t\t// TODO - add test/ensure that this will reach the parent before popstate event (in browsers where the popstate event fires on the parent)\n\t\t// Maybe we should just until parent acknowledges message?\n\t\twindow.parent.postMessage({\n\t\t\tsetModalCloseValue: value,\n\t\t}, '*');\n\t}\n}\nfunction exit() {\n\twindow.parent.postMessage({\n\t\tcloseModal: true,\n\t}, '*');\n}\nfunction prepareChildDocument() {\n\twindow.parent.postMessage({\n\t\tmodalChildTitled: document.title,\n\t}, '*');\n\n\tconst target = document.querySelector('[autofocus]');\n\tif (target) {\n\t\ttarget.focus();\n\t}\n\telse {\n\t\tdocument.body.tabIndex = -1;\n\t\tdocument.body.focus();\n\t}\n}\nfunction didNavigateForward() {\n\t// current API\n\ttry {\n\t\treturn performance.getEntriesByType('navigation')[0].type == 'navigate';\n\t} catch(e) {\n\t\t// older API\n\t\tconst n = performance.navigation;\n\t\treturn n.type === n.TYPE_NAVIGATE\n\t}\n}\n/*\n\tReminder - if current history state was not created in this window (ie. the \"initial state\"), then reading it will return null or raise error in some browsers.\n*/\nfunction historyStateIsReadableAndHasKey(key) {\n\ttry {\n\t\treturn key in history.state\n\t} catch(e) {\n\t\treturn false\n\t}\n}\n/*\n\tPatch pushState so that it always increments history depth and session depth.\n\n\tThis allows us to keep track of history depth, even if the document in the modal window is using pushState.\n\n\tWe do require, however, that you always push a \"simple object\" (ie. something that serializes to a json dictionary) as the state object, so that we can attach our own data to it.\n\n\tTODO - verify that this works\n*/\nfunction patchPushState() {\n\tconst _pushState = history.pushState.bind(history);\n\thistory.pushState = function(data, title, url) {\n\t\tif (!data || JSON.stringify(data)[0] != '{') {\n\t\t\tthrow new Error('Pages inside a modal window may use history.pushState, but they must pass a \"simple object\" (NOT Array, String, Number, null, etc.) as the state object');\n\t\t}\n\t\tconst newDepth = history.state[depthKey] + 1;\t\t\n\t\tsessionStorage[depthKey] = newDepth;\n\t\tdata[depthKey] = newDepth;\n\t\t_pushState(data, title, url);\n\t}\n}\n\n// Make sure this is actually a modal child before we do anything\nif (isModalChild()) {\n\tconsole.debug('initializing modal child');\n\t/*\n\t\tWe need per-window storage on both the history state entry and in sessionStorage.\n\n\t\tFor same-domain iframes, these are shared between iframe and parent window (in some browsers, at least). We need a persistent, unique key to identify this window. We use window name for that key.\n\t*/\n\twindow.name = window.name || 'openModalWindow'+Date.now();\n\n\tdepthKey = window.name + 'historyDepth';\n\n\tif (!(depthKey in sessionStorage)) {\n\t\t/*\n\t\t\tThe modal window has just been opened.\n\t\t\tWe are in the \"initial state\".\n\t\t\tPush a new state, so that we detect history.back().\n\t\t\tIf we ever get back to the \"initial state\", we'll close this modal window.\n\t\t*/\n\t\thistory.pushState({[depthKey]: 1}, '', location.href);\n\t\tsessionStorage[depthKey] = 1;\n\t}\n\telse if(historyStateIsReadableAndHasKey(depthKey)) {\n\t\t// This page was reloaded from back/forward\n\t\tsessionStorage[depthKey] = history.state[depthKey];\n\t}\n\telse if (didNavigateForward()) {\n\t\tconst newDepth = parseInt(sessionStorage[depthKey]) + 1;\n\t\tsessionStorage[depthKey] = newDepth;\n\t\tconst s = history.state || {};\n\t\ts[depthKey] = newDepth;\n\t\thistory.replaceState(s, '', location.href);\n\t}\n\telse {\n\t\t// User navigated back to initial state (and that navigation involved actual page navigation, not just states created with pushState)\n\t\texit();\n\t}\n\n\tpatchPushState();\n\n\taddEventListener('popstate', function() {\n\t\tconsole.debug(`popped state in child ${location.href}`);\n\t\tif (!historyStateIsReadableAndHasKey(depthKey)) {\n\t\t\texit();\n\t\t\treturn\n\t\t}\n\n\t\t/*\n\t\t\tIE hack\n\t\t\tIE _sometimes_ lies to us about what state we're in, when we've gone back to the initial state.\n\n\t\t\tIf we get a popstate event and history.state[depthKey] hasn't changed, assume we're in the initial state and IE is lying to us.\n\n\t\t\tONLY do this for IE 11. Some browsers (Safari) fire popstate events at initial page load (when reloading from history), and in that case history.state[depthKey] WILL equal lastDepth.\n\t\t*/\n\t\tif (navigator.userAgent.indexOf(\"Trident/7.0\") > -1 && history.state[depthKey] == sessionStorage[depthKey]) {\n\t\t\texit();\n\t\t\treturn\n\t\t}\n\n\t\tsessionStorage[depthKey] = history.state[depthKey];\n\t});\n\n\tprepareChildDocument();\n}\n","// Element.closest polyfill, courtesy of MDN\nif (!Element.prototype.matches) {\n  Element.prototype.matches = Element.prototype.msMatchesSelector || \n                              Element.prototype.webkitMatchesSelector;\n}\nif (!Element.prototype.closest) {\n  Element.prototype.closest = function(s) {\n    var el = this;\n\n    do {\n      if (Element.prototype.matches.call(el, s)) return el;\n      el = el.parentElement || el.parentNode;\n    } while (el !== null && el.nodeType === 1);\n    return null;\n  };\n}\n\ndocument.addEventListener('click', function(e) {\n  const link = e.target.closest('a[target=_modal]');\n  if (!link) return\n  if (e.ctrlKey || e.shiftKey || e.metaKey) return\n  if (e.defaultPrevented) return\n  e.preventDefault();\n  openModal(link.href);\n});"],"names":["iframe","lockedScrollTop","lockedScrollLeft","previousActiveElement","onModalclose","modalCloseValue","addEventListener","e","source","contentWindow","data","modalChildTitled","setAttribute","console","debug","_setOpenModalCloseValue","setModalCloseValue","closeModal","window","value","postMessage","Error","parentElement","removeChild","removeEventListener","fixScroll","cancel","document","body","refocus_iframe","focus","openModal","url","options","activeElement","documentElement","scrollLeft","scrollTop","onclose","createIframe","background","style","onload","src","i","createElement","s","position","top","left","width","height","border","margin","padding","zIndex","appendChild","event","stopPropagation","preventDefault","depthKey","isModalChild","parent","history","go","parseInt","sessionStorage","setTimeout","exit","prepareChildDocument","title","target","querySelector","tabIndex","didNavigateForward","performance","getEntriesByType","type","n","navigation","TYPE_NAVIGATE","historyStateIsReadableAndHasKey","key","state","patchPushState","_pushState","pushState","bind","JSON","stringify","newDepth","name","Date","now","location","href","replaceState","navigator","userAgent","indexOf","Element","prototype","matches","msMatchesSelector","webkitMatchesSelector","closest","el","call","parentNode","nodeType","link","ctrlKey","shiftKey","metaKey","defaultPrevented"],"mappings":"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"}